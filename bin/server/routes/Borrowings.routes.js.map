{"version":3,"sources":["../../../src/server/routes/Borrowings.routes.js"],"names":["express","require","jwt","router","Router","get","isLogged","req","res","Borrowing","find","then","borrowings","status","json","catch","err","errors","message","post","user_id","verify","body","token","SECRET","book_id","findOne","borrow","startDate","Date","now","state","undefined","backDate","save","User","_id","user","push","send","patch","id","params","findOneAndUpdate","returned","borrowing","succed","module","exports"],"mappings":"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","sourcesContent":["import {SECRET, isLogged} from \"./Middleware.routes\";\nimport User from \"../models/User\";\nimport Borrowing from \"../models/Borrowing\";\n\nconst express = require(\"express\");\nconst jwt = require(\"jsonwebtoken\");\n\nlet router = new express.Router();\n\nrouter.get(\"/\", [isLogged], (req, res) => {\n    Borrowing.find()\n        .then(borrowings => {\n            res.status(200).json(borrowings);\n        })\n        .catch(err => {\n            res.status(404).json({errors: [err.message]});\n        });\n});\n\nrouter.post(\"/\", [isLogged], (req, res) => {\n    const user_id = jwt.verify(req.body.token, SECRET);\n    const book_id = req.body.book_id;\n\n    Borrowing.findOne({book_id: book_id, user_id: user_id}).then(() => {\n        res.status(403).json({errors: [\"This book has already been borrowed\"]});\n    });\n\n    let borrow = new Borrowing();\n\n    borrow.user_id = user_id;\n    borrow.book_id = book_id;\n    borrow.startDate = Date.now();\n    borrow.state = undefined;\n    borrow.backDate = undefined;\n    borrow.save();\n\n    User.findOne({_id: user_id.user})\n        .then(user => {\n            user.borrowings.push(borrow._id);\n            user.save();\n        })\n        .catch(err => {\n            res.status(500).send({errors: [err.message]});\n        });\n\n    res.status(200).json({borrow: borrow});\n});\n\nrouter.patch(\"/return/:id\", [isLogged], (req, res) => {\n    const id = req.params.id;\n\n    Borrowing.findOneAndUpdate({_id: id, returned: false})\n        .then(borrowing => {\n            borrowing.returned = true;\n            borrowing.backDate = Date.now();\n            borrowing.save();\n\n            res.status(200).json({\n                succed: [\"You have returned this book, this is so nice!\"],\n            });\n        })\n        .catch(err => {\n            res.status(404).json({errors: [err.message, \"No item found\"]});\n        });\n});\n\nmodule.exports = router;\n"],"file":"Borrowings.routes.js"}